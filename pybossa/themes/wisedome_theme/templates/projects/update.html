{% extends "projects/base.html" %}
{% set active_page = "projects" %}
{% set active_link = "settings" %}
{% import "projects/_helpers.html" as helper %}

{% block projectcontent %}
{% from "_formhelpers.html" import render_field, render_checkbox_field %}
<h2>프로필 사진 업데이트</h2>
<form method="post" action="{{ url_for('project.update', short_name=project.short_name) }}" enctype="multipart/form-data">
    <fieldset>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <div>
            <img id="uploadPreview" style="max-width: 100%">
        </div>
        {{ render_field(upload_form.avatar, onchange="previewImage()") }}
        {{ upload_form.x1 }}
        {{ upload_form.y1 }}
        {{ upload_form.x2 }}
        {{ upload_form.y2 }}
        <div class="form-actions">
            <button type="submit" name='btn' value="Upload" class="btn btn-primary">{{ _('Upload') }}</button>
        </div>
    </fieldset>
</form>

<style>
select.form-control {
	color:black;
}
select.form-control:focus {
	color:black;
}
</style>

<!-- Update form for project data-->
<h2>프로젝트 세부 사항</h2>
<form method="post" action="{{ url_for('project.update', short_name = project.short_name) }}">
    <fieldset>
        {{ form.hidden_tag() }}
        {{ render_field(form.name, class_="input-xlarge", placeholder=_('The name of the project')) }}
        {{ render_field(form.short_name, class_="input-xlarge", placeholder=_('Short name or slug for the project'), label_text=_('Project slug:')) }}
		{{ render_field(form.all_point, class_="input-xlarge") }}
        {{ render_field(form.description, class_="input-xlarge", placeholder='프로젝트에 대한 간단한 설명을 입력하시오.') }}
		{{ render_field(form.long_description, class_="input-xlarge", placeholder='프로젝트에 대한 자세한 설명을 입력하시오.(마크다운 사용 가능)') }}
		<div class="form-group input-xlarge">
			<label for="end_date" class="control-label">
				<label for="end_date">프로젝트 마감기한<span style="color:red;"> (필수 입력)</span></label>
			</label>
			<input class='form-control' type='date' id='end_date' name='end_date' value='{{form.end_date[0:10]}}'>
		</div>
		<div class ="row">
			<h3 class ='col-sm-12'><strong>프로젝트 제한사항</strong></h3>
			{{ render_field(form.option_sex, class_="col-sm-3") }}
			{{ render_field(form.option_age_start, class_="col-sm-3", placeholder=_('몇 살부터')) }}
			{{ render_field(form.option_age_end, class_="col-sm-3", placeholder=_('몇 살까지')) }}
		</div>
		<div class="row">
			{{ render_field(form.option_all_achieve, class_="col-sm-3") }}
			{{ render_field(form.option_cat_achieve, class_="col-sm-3") }}
			<div class="form-group col-sm-3">
				<label for="self_score" class="control-label">
					<label for="self_score">채점 방식</label>
				</label>
				<select class="form-control" id="self_score" name="self_score">
					<option {% if form.self_score == "True" %}selected{% endif %} value="True">수동</option>
					<option {% if form.self_score == "False" %}selected{% endif %} value="False">자동</option>
				</select>
			</div>
			<h4 class ='col-sm-8' style="margin-bottom:30px;">제한이 필요 없으시다면 빈칸으로 남겨주세요. </h4>
		</div>

		{{ render_field(form.category_id) }}
		<div style="display:none;">
        {{ render_checkbox_field(form.allow_anonymous_contributors, class_="", tooltip=_('Check if you want to allow anonymous users contribute to your project')) }}
        {{ render_checkbox_field(form.zip_download, class_="", tooltip=_("Check if you want to disable anonymous users to download project's data")) }}
		</div>
		{{ render_checkbox_field(form.protect, id='protect') }}
        <div id='password'>{{ render_field(form.password) }}</div>
        {{ render_field(form.webhook) }}

        <div class="form-actions">
            <button type="submit" name='btn' value="Save the changes" class="btn btn-primary">저장</button>
        </div>
    </fieldset>
</form>
<h3>프로젝트 키</h3>
<div class="input-group">
    <input type="password" name="secret-key" class="form-control" id="project-secret-key" style="width:100%;" readonly value="{{project.secret_key}}">
    <span class="input-group-btn"><buton id="password-toggle" class="btn btn-primary"><i class="fa fa-eye password-toggle"></i><i class="fa fa-eye-slash password-toggle" style="display:none"></i></buton></span>
</div>
<p style="margin-top: 15px;">
<form method="post" action="{{ url_for('project.reset_secret_key', short_name=project.short_name)}}">
    <div class="form-actions">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <button type="submit" class="btn btn-primary" value="Reset">키 초기화</button>
    </div>
</form>
<h3>{{_('Webpush notifications')}}</h3>
<p><span class="label label-info"><i class="fa fa-bullhorn"></i> {{_('Warning')}}</span> {{_('Once you enable the notifications, you cannot disable them.')}}</p>
{% if project.info.get('onesignal') == None %}
<button id="webpush" class="btn btn-primary" value="webpush">{{_('Activate')}}</button>
{% else %}
<button class="btn btn-primary disabled" value="webpush">{{_('Enabled')}}</button>
{% endif %}

<h3>프로젝트 관리자 변경</h3>
<a href="{{url_for('project.transfer_ownership', short_name=project.short_name)}}" class="btn btn-primary">관리자 변경</a>
</p>
{% endblock %}
{% block extrajs %}
<script>
    var pybossaAvatarAspectRatio = "NaN";
</script>
<script>
    $("#webpush").off('click').on('click', function(){
        var url = window.location.href.split("update")[0] + "webpush";
        $.get(url, function(data){
            console.log(data);
            if (data['id'] !== undefined) {
                pybossaNotify('Webpush notifications enabled', true, 'success');
            }
        });
    })
</script>
<script src="{{url_for('static', filename='js/vendor/cropper.min.js')}}"></script>
<link rel="stylesheet" href="{{url_for('static', filename='css/cropper.min.css')}}" type="text/css" />
<script src="{{url_for('static', filename='js/image_crop.js')}}" type="text/javascript"></script>
<script type="text/javascript">
$(function() {
        var passProtected = document.getElementById('protect').checked;
        if (!passProtected) {
        $('#password').hide();
        }
        $('#protect').on('change', function() {
            $('#password').toggle();
            });
        });

        //Show/hide secret key
        $(window).load(function(){
            $(".fa-eye-slash").hide();
            $("#password-toggle").click(function(evt){
                evt.preventDefault();
                $(".password-toggle").toggle();
                if ( $("#project-secret-key").attr("type") == 'password') {
                    $("#project-secret-key").attr("type", 'text');
                }
                else {
                    $("#project-secret-key").attr("type", 'password');
                }
            });
        });
</script>
{% endblock %}

